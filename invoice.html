<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NMD Accountancy</title>
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
body {
    font-family: Inter, Segoe UI, Roboto, Arial;
    margin: 0;
    background-color: #0a0f0d;
    color: #e0f2f1;
}
/* Sidebar */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 220px;
    height: 100%;
    background-color: #123822;
    padding-top: 20px;
    display: flex;
    flex-direction: column;
    transition: width 0.3s;
    overflow: hidden;
}
.sidebar.collapsed {
    width: 60px;
}
.sidebar .logo {
    width: 120px;
    margin: 20px;
    margin-left: 60px;
    transition: width 0.3s, margin 0.3s;
}
.sidebar.collapsed .logo {
    margin-left: 10px;
}
.sidebar .logo img {
    width: 70%;
    border-radius: 100%;
    border: solid;
    border-color: aquamarine;
}
.sidebar.collapsed .logo img {
    width: 30%;
}
.sidebar a {
    padding: 15px 20px;
    text-decoration: none;
    color: #e0f2f1;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.3s;
    font-weight: 500;
}
.sidebar.collapsed a span.text {
    display: none;
}
.sidebar a svg {
    width: 20px;
    height: 20px;
    fill: #e0f2f1;
}
.sidebar a:hover {
    background-color: #2e7d60;
}
.sidebar a.active {
    background-color: #1b5e43;
}
/* Sidebar toggle button */
#sidebarToggle {
    cursor: pointer;
    color: #a8e6cf;
    font-size: 1.5rem;
    text-align: center;
    margin-bottom: 20px;
    transition: transform 0.3s;
}
#sidebarToggle.collapsed {
    transform: rotate(180deg);
}

/* Main content */
.main-content {
    margin-left: 220px;
    padding: 30px 40px;
    transition: margin-left 0.3s;
    background-color: #0a0f0d;
    min-height: 100vh;
}
.sidebar.collapsed ~ .main-content {
    margin-left: 60px;
}

.main-content h1{
    text-align: left;
}


/* Change calendar icon color to green */
input[type="date"]::-webkit-calendar-picker-indicator {
    filter: invert(48%) sepia(82%) saturate(550%) hue-rotate(90deg);
    cursor: pointer;
}


/* Top Bar */
#topBar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
    font-weight: 500;
    color: #a8e6cf;
    font-size: 0.95rem;
}

/* Form Inputs */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
    gap: 30px;
    margin-bottom: 20px;
}
label {
    display: block;
    margin-bottom: 8px;
    color: #a8e6cf;
    font-weight: 500;
}
input, select {
    width: 90%;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #1b5e36;
    background-color: #123822;
    color: #e0f2f1;
}
button {
    padding: 8px 16px;
    margin: 5px 5px 5px 0;
    border-radius: 5px;
    background-color: #2e7d60;
    color: #e0f2f1;
    border: none;
    cursor: pointer;
    transition: 0.3s;
}
button:hover {
    background-color: #1b5e43;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
table th, table td {
    border:1px solid #1b5e36;
    padding:8px;
    text-align:left;
}
table th {
    background-color:#2e7d60;
}
h3{
    color: #a8e6cf;
}

h1 { text-align: center; color: #a8e6cf; }
.preview-box {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #1b5e36;
    background: #123822;
    border-radius: 8px;
}

    /* Styles unchanged from your existing code */
        .invoice-preview {
      font-family: Inter, Segoe UI, Roboto, Arial;
      background: #fff;
      color: #111;
      padding: 15mm 15mm;
      border-radius: 12px;
      width: 190mm;
      max-width: 100%;
      margin: 10mm auto;
      box-sizing: border-box;
      box-shadow: 0 6px 18px rgba(2,6,23,0.1);
    }
    .invoice-title { font-size: 28px; font-weight:700; text-align:left; margin-bottom:20px; margin-top:80px; }
    .invoice-info { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:15px; gap:10px; }
    .invoice-to, .invoice-details { flex:1; min-width:180px; }
    #linesTable { width:100%; border-collapse:collapse; margin-bottom:10px; font-size:12px; }
    #linesTable th, #linesTable td { border:1px solid #ddd; padding:6px 5px; text-align:left; }
    #linesTable th { background:#2e7d60; color:#fff; font-weight:600; }
    #linesTable td.right { text-align:right; }
    .invoice-bottom { display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; }
    .invoice-left { flex:1; min-width:180px; }
    .invoice-thanks { margin-bottom:8px; }
    .thanks-title {font-weight:700; font-size:18px; margin-bottom:8px;}
    .payment-title { font-weight:700; font-size:14px; margin-bottom:4px; } /* same size */
    .payment-text, .bank-details, .cheque-payment1 { font-size:12px; line-height:1.2; color:#333; }
    .invoice-totals { flex:1; min-width:150px; display:flex; flex-direction:column; gap:5px; }
    .invoice-totals > div { display:flex; justify-content:space-between; font-weight:500; font-size:12px; padding:4px 6px; }
    .final-amount { font-weight:700; font-size:14px; background:#616363; color:#fff; padding:4px 6px; border-radius:4px; }
    .cheque-payment { margin-top:10px; }
    .invoice-footer { margin-top:50px; font-size:10px; color:#555; text-align:center; }
    @media print {
      body{ margin:0; -webkit-print-color-adjust:exact; color:#000; }
      .invoice-preview { box-shadow:none; border-radius:0; width:190mm; padding:15mm; margin:0 auto; page-break-inside:avoid; }
      #linesTable th, #linesTable td { padding:5px 4px; font-size:11px; }
      .invoice-totals > div { font-size:11px; }
      .payment-text, .bank-details, .cheque-payment1 { font-size:11px; }
      .invoice-footer { font-size:9px; }
      #linesTable tr { page-break-inside:avoid; }
    }

/* Small screens (mobile) */
@media screen and (max-width: 768px) {
    .sidebar {
        width: 60px; /* collapse sidebar on mobile */
    }
    .sidebar.collapsed {
        width: 60px;
    }
    .sidebar .logo {
        margin-left: 10px;
        width: 80px;
    }
    .sidebar .logo img {
        width: 40%;
    }
    .sidebar a span.text {
        display: none; /* hide sidebar labels */
    }
    .main-content {
        margin-left: 60px; /* adjust content margin */
        padding: 20px;
    }

    /* Top Bar */
    #topBar {
        flex-wrap: wrap; /* allow wrapping */
        font-size: 0.85rem;
        gap: 10px;
    }

    /* Headings */
    .main-content h1 {
        font-size: 1.5rem;
    }

    /* Form Inputs */
    .main-content input[type="text"] {
        width: 90%;
        font-size: 0.9rem;
    }

    /* Buttons */
    .main-content button {
        padding: 8px 14px;
        font-size: 0.9rem;
        margin-left: 0;
    }

    /* Tables */
    .main-content table {
        font-size: 0.85rem;
        overflow-x: auto;
        display: block;
    }
}

/* Medium screens (tablets) */
@media screen and (max-width: 1024px) {
    .main-content {
        padding: 25px 40px;
    }

    .main-content h1 {
        font-size: 1.75rem;
    }

    .main-content input[type="text"] {
        width: 90%;
    }

    .main-content button {
        padding: 9px 16px;
    }

    #topBar {
        font-size: 0.9rem;
        gap: 15px;
    }
}

/* Extra small screens (phones) */
@media screen and (max-width: 480px) {
    .main-content {
        padding: 15px 20px;
    }

    .main-content input[type="text"] {
        width: 93%;
    }

    .main-content button {
        width: 100%;
        margin-left: 0;
    }

    .main-content table th,
    .main-content table td {
        padding: 6px;
    }

    .main-content table {
        font-size: 0.8rem;
    }

    .sidebar .logo {
        width: 70px;
    }

    .sidebar .logo img {
        width: 35%;
    }
}

/* Responsive font size adjustments */
@media screen and (max-width: 768px) {
    .watermark-footer {
        font-size: 10px;
        padding: 3px 10px;
    }
}

@media screen and (max-width: 480px) {
    .watermark-footer {
        font-size: 9px;
        padding: 2px 5px;
    }
}

</style>
</head>
<body>

<div class="sidebar">
    <div id="sidebarToggle">◀</div>
    <div class="logo">
        <img src="invoice.jpg" alt="NMD Accountancy Logo">
    </div>
    <a href="dashboard.html" id="navDashboard">
        <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/></svg>
        <span class="text">Dashboard</span>
    </a>
    <a href="clients.html">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4S14.21 4 12 4 8 5.79 8 8s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
        <span class="text">Add Clients</span>
    </a>
    <a href="invoice.html" id="navCreate">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2V5a2 2 0 00-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
        <span class="text">Create Invoice</span>
    </a>
    <a href="edit.html" id="navSaved">
        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        <span class="text">Manage Invoices</span>
    </a>
    <a href="cover.html" id="navDownload">
        <svg viewBox="0 0 24 24" width="24" height="24"> <path d="M19 8H5c-1.1 0-2 .9-2 2v6h4v4h10v-4h4v-6c0-1.1-.9-2-2-2zm-1 8H6v-5h12v5zm-5-9h-2V3h2v4z"/></svg>
        <span class="text">Cover Page</span>
    </a>
   <a href="#" id="navLogout">
        <svg viewBox="0 0 24 24"><path d="M16 13v-2H7V7l-5 5 5 5v-4h9zm3-10H5c-1.1 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
        <span class="text">Logout</span>
    </a>
</div>

<div class="main-content">
    <div id="topBar">
        <span id="adminName">Admin: NMD Accountancy</span>
        <span id="systemDateTime"></span>
    </div>
    <h1>Create Invoice</h1>

    <div class="form-grid">
        <div>
            <label>Type:</label>
            <select id="invoiceType">
                <option value="INV">Invoice</option>
                <option value="QT">Quotation</option>
            </select>
        </div>
        <div>
            <!-- Invoice Date -->
<label for="date"> Date:</label>
<input type="date" id="invoiceDate" name="invoiceDate" required>
          
        </div>
        <div>
            <label>Number:</label>
            <input type="text" id="invoiceNumber" readonly>
        </div>
        <div>
            <label>Client Name:</label>
            <input list="clientsList" id="clientName" placeholder="Select or type client">
            <datalist id="clientsList"></datalist>
        </div>
        <div>
            <label>Contact Number:</label>
            <input type="text" id="contactNumber" placeholder="Contact number">
        </div>
        <div>
            <label>Address:</label>
            <input type="text" id="clientLocation" placeholder="Address">
        </div>

        <div>
            <label>Discount (%):</label>
            <input type="number" id="discountPercent" placeholder="Enter discount %" min="0" max="100" value="0">
        </div>

    </div>

    <hr>

    <h3>Items</h3>
    <table id="invoiceTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Line Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button id="addLine">Add Line</button>
    <button id="generateInvoice">Save Invoice</button>

    <hr>
    <h3>Invoice Preview</h3>
    <div id="invoicePreview" class="preview-box">
        <p>No invoice to preview yet.</p>
    </div>
</div>

<!-- Watermark Footer -->
<div style="position: fixed; bottom: 0; right: 0; width: 100%; text-align: right; 
            font-size: 12px; color: rgba(255,255,255,0.2); padding: 5px 20px; 
            pointer-events: none; user-select: none; z-index: 9999;">
    &copy; Developed by Grow More Solutions Pvt Ltd
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
    // ------------------------------
    // LOGIN CHECK
    // ------------------------------
    if(localStorage.getItem('isLoggedIn') !== 'true'){
        alert('Please login first!');
        window.location.href = 'home.html';
    }

    // ===== Utilities =====
    function formatNumber(num){ return parseFloat(num || 0).toFixed(2); }
    function getMonthCode(date){
        const month = new Date(date).getMonth();
        return ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"][month];
    }

    // ===== Invoice Number =====
    function generateInvoiceNumber(type, date) {
        const monthCode = getMonthCode(date);
        let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        let existingNumbers = invoices
            .map(inv => inv.number ? parseInt((inv.number.split('/')[3] || ""), 10) : 0)
            .filter(num => !isNaN(num));
        let nextNumber = 1;
        while(existingNumbers.includes(nextNumber)) nextNumber++;
        let next = nextNumber.toString().padStart(4, '0');
        return `${type}/NMD/${monthCode}/${next}`;
    }

    let editingInvoiceNumber = null;
    function updateInvoiceNumberField(){
        const type = document.getElementById("invoiceType").value;
        const date = document.getElementById("invoiceDate").value;
        if(editingInvoiceNumber){
            document.getElementById("invoiceNumber").value = editingInvoiceNumber;
        } else if(date){
            document.getElementById("invoiceNumber").value = generateInvoiceNumber(type, date);
        } else {
            document.getElementById("invoiceNumber").value = '';
        }
    }

    // ===== Clients Dropdown =====
    function populateClientsDropdown(){
        const clients = JSON.parse(localStorage.getItem('clients') || '[]');
        const dataList = document.getElementById('clientsList');
        dataList.innerHTML = '';
        clients.forEach(c => {
            const option = document.createElement('option');
            option.value = c.name;
            dataList.appendChild(option);
        });
    }

    function handleClientChange(){
        const clients = JSON.parse(localStorage.getItem('clients') || '[]');
        const selected = clients.find(c => c.name.toLowerCase() === this.value.toLowerCase());
        if(selected){
            document.getElementById("contactNumber").value = selected.contact;
            document.getElementById("clientLocation").value = selected.location;
        } else {
            // do not clear if user is just typing — keep blank only if not found
            document.getElementById("contactNumber").value = '';
            document.getElementById("clientLocation").value = '';
        }
        updatePreview();
    }

    // ===== Invoice Table helpers =====
    let invoiceCount = 0;
    const invoiceTableBody = document.querySelector("#invoiceTable tbody");

    function addLineRow(desc='', qty=1, price=0){
        invoiceCount++;
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${invoiceCount}</td>
            <td><input type="text" value="${escapeHtml(desc)}" placeholder="Description"></td>
            <td><input type="number" value="${qty}" min="1"></td>
            <td><input type="number" value="${price}" min="0" step="0.01"></td>
            <td class="lineTotal">${formatNumber(qty*price)}</td>
            <td><button class="removeLine">Delete</button></td>
        `;
        invoiceTableBody.appendChild(row);

        // attach listeners
        row.querySelectorAll("input").forEach(input => input.addEventListener("input", updateLineTotal));
        row.querySelector(".removeLine").addEventListener("click", ()=> {
            if(confirm("Remove this line?")){
                row.remove();
                updateLineNumbers();
                updatePreview();
            }
        });

        updatePreview();
    }

    function updateLineTotal(){
        // `this` is the input
        const row = this.closest("tr");
        const q = parseFloat(row.children[2].children[0].value) || 0;
        const p = parseFloat(row.children[3].children[0].value) || 0;
        row.children[4].textContent = formatNumber(q * p);
        updatePreview();
    }

    function updateLineNumbers(){
        Array.from(invoiceTableBody.children).forEach((row, i) => { row.children[0].textContent = i+1; });
        invoiceCount = invoiceTableBody.children.length;
    }

    // Simple HTML escape for value injection
    function escapeHtml(str){
        if(!str) return '';
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // ===== Build invoice object from current form ====
    function buildCurrentInvoice(){
        const type = document.getElementById("invoiceType").value;
        const date = document.getElementById("invoiceDate").value;
        const number = document.getElementById("invoiceNumber").value;
        const client = document.getElementById("clientName").value.trim();
        const contact = document.getElementById("contactNumber").value.trim();
        const location = document.getElementById("clientLocation").value.trim();
        const discount = parseFloat(document.getElementById("discountPercent").value) || 0;

        const items = Array.from(invoiceTableBody.children).map(row => ({
            description: row.children[1].children[0].value,
            qty: parseFloat(row.children[2].children[0].value) || 0,
            price: parseFloat(row.children[3].children[0].value) || 0,
            lineTotal: parseFloat(row.children[4].textContent) || 0
        }));

        return { number, type, date, client, contact, location, items, discount };
    }

// ------------------------------
// SHOW INVOICE PREVIEW
// ------------------------------
function showPreview(inv) {
    if (!inv || !inv.items) {
        document.getElementById("invoicePreview").innerHTML = "<p>No invoice to preview yet.</p>";
        return;
    }

    // Render the preview using the same HTML structure as getInvoiceHTML
    document.getElementById("invoicePreview").innerHTML = getInvoiceHTML(inv);
}

// ------------------------------
// HELPER FUNCTIONS
// ------------------------------
function formatCurrency(value) {
    return Number(value).toLocaleString('en-LK', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function escapeHtml(text) {
    if (!text) return '';
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}



    
// ------------------------------
// INVOICE HTML FOR PRINT PREVIEW
// ------------------------------
function getInvoiceHTML(inv){
    let subtotal = inv.items.reduce((sum,it)=>sum + it.lineTotal,0);
    let discount = inv.discount || 0; // in percentage
    let discountAmount = subtotal * (discount/100);
    let finalAmount = subtotal - discountAmount;

    let rows = inv.items.map((it,i)=>`
        <tr>
            <td style="width:5%">${i+1}</td>
            <td style="width:50%">${it.description}</td>
            <td style="width:10%">${it.qty}</td>
            <td style="width:15%"> ${formatCurrency(it.price)}</td>
            <td style="width:20%" class="right"> ${formatCurrency(it.lineTotal)}</td>
        </tr>`).join('');

    return `
    <div class="invoice-preview">
        <div class="invoice-title">${inv.type === 'QT' ? 'QUOTATION' : 'INVOICE'}</div>
        <div class="invoice-info">
            <div class="invoice-to">
                <div><strong>To:</strong></div>
                <div>Name: ${inv.client}</div>
                <div>Contact: ${inv.contact}</div>
                <div>Address: ${inv.location}</div>
            </div>
            <div class="invoice-details">
                <div><strong>Invoice No:</strong> ${inv.number}</div>
                <div><strong>Invoice Date:</strong> ${inv.date}</div>
            </div>
        </div>
        <table id="linesTable">
            <thead>
                <tr>
                    <th style="width:5%">#</th>
                    <th style="width:47%">Description</th>
                    <th style="width:10%">QTY</th>
                    <th style="width:18%">Unit Price(LKR)</th>
                    <th style="width:20%" class="right">Total</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
        <div class="invoice-bottom">
            <div class="invoice-left">
                <div class="invoice-thanks">
                    <div class="thanks-title">Thank You for your Business</div>
                    <div class="payment-title">Payment Instructions</div>
                    <div class="payment-text">
                        Please make the payment to the bank details provided below.
                        If you have any questions or need additional information, please contact us at 0777178196.
                    </div>
                </div>
                <div class="bank-details">
                    <div class="payment-title">Bank Details</div>
                    Bank Name: Commercial Bank<br>
                    Account Name: Neranjala Sekar<br>
                    Account Number: 8240009545<br>
                    Bank Branch: Pettah Branch<br>
                </div>
            </div>
            <div class="invoice-totals">
                <div class="subtotal"><div>Subtotal</div><div>LKR ${formatCurrency(subtotal)}</div></div>
                <div class="discount"><div>Discount (${discount}%)</div><div>LKR ${formatCurrency(discountAmount)}</div></div>
                <div class="final-amount"><div>Total</div><div>LKR ${formatCurrency(finalAmount)}</div></div>
            </div>
        </div>
        <div class="cheque-payment">
            <div class="payment-title">Cheque Payment</div>
            <div class="cheque-payment1">Please make the cheque payable to: NMD Accountancy</div>
        </div>
        <div class="invoice-footer">
            If you have any questions about this invoice, please contact <b>nmdacc2018@gmail.com</b> or <b>0777178196</b>
        </div>
    </div>`;
}

// ------------------------------
// PRINT INVOICE
// ------------------------------
function printInvoice(inv){
    const w = window.open('', '', 'height=900,width=800');
    const css = `
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
    /* Styles unchanged from your existing code */
        .invoice-preview {
      font-family: Inter, Segoe UI, Roboto, Arial;
      background: #fff;
      color: #111;
      padding: 15mm 15mm;
      border-radius: 12px;
      width: 190mm;
      max-width: 100%;
      margin: 10mm auto;
      box-sizing: border-box;
      box-shadow: 0 6px 18px rgba(2,6,23,0.1);
    }
    .invoice-title { font-size: 28px; font-weight:700; text-align:left; margin-bottom:20px; margin-top:80px; }
    .invoice-info { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:15px; gap:10px; }
    .invoice-to, .invoice-details { flex:1; min-width:180px; }
    #linesTable { width:100%; border-collapse:collapse; margin-bottom:10px; font-size:12px; }
    #linesTable th, #linesTable td { border:1px solid #ddd; padding:6px 5px; text-align:left; }
    #linesTable th { background:#2e7d60; color:#fff; font-weight:600; }
    #linesTable td.right { text-align:right; }
    .invoice-bottom { display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; }
    .invoice-left { flex:1; min-width:180px; }
    .invoice-thanks { margin-bottom:8px; }
    .thanks-title {font-weight:700; font-size:18px; margin-bottom:8px;}
    .payment-title { font-weight:700; font-size:14px; margin-bottom:4px; } /* same size */
    .payment-text, .bank-details, .cheque-payment1 { font-size:12px; line-height:1.2; color:#333; }
    .invoice-totals { flex:1; min-width:150px; display:flex; flex-direction:column; gap:5px; }
    .invoice-totals > div { display:flex; justify-content:space-between; font-weight:500; font-size:12px; padding:4px 6px; }
    .final-amount { font-weight:700; font-size:14px; background:#616363; color:#fff; padding:4px 6px; border-radius:4px; }
    .cheque-payment { margin-top:10px; }
    .invoice-footer { margin-top:50px; font-size:10px; color:#555; text-align:center; }
    @media print {
      body{ margin:0; -webkit-print-color-adjust:exact; color:#000; }
      .invoice-preview { box-shadow:none; border-radius:0; width:190mm; padding:15mm; margin:0 auto; page-break-inside:avoid; }
      #linesTable th, #linesTable td { padding:5px 4px; font-size:11px; }
      .invoice-totals > div { font-size:11px; }
      .payment-text, .bank-details, .cheque-payment1 { font-size:11px; }
      .invoice-footer { font-size:9px; }
      #linesTable tr { page-break-inside:avoid; }
    }
    </style>`;
    w.document.write(css + getInvoiceHTML(inv));
    w.document.close();
    w.focus();
    w.print();
}


// ------------------------------
// GENERATE PDF
// ------------------------------
function generatePDF(inv) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 25.4; // 1 inch margin

    if (window.invoiceBgBase64) {
        doc.addImage(window.invoiceBgBase64, "JPEG", 0, 0, pageWidth, pageHeight);
    }

    // Invoice Info
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.text(inv.type === 'QT' ? "QUOTATION" : "INVOICE", 15, 25);

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    let yLeft = 40;
    doc.text(`To:`, 15, yLeft);
    yLeft += 7; doc.text(`Name: ${inv.client}`, 15, yLeft);
    yLeft += 7; doc.text(`Contact: ${inv.contact}`, 15, yLeft);
    yLeft += 7; doc.text(`Address: ${inv.location}`, 15, yLeft);

let yRight = 40;
const rightX = pageWidth - 80;

// Invoice No
doc.setFont("helvetica", "bold");
doc.text("Invoice No:", rightX, yRight);
doc.setFont("helvetica", "normal");
doc.text(`${inv.number}`, rightX + 30, yRight); // 30mm offset for value
yRight += 7;

// Invoice Date
doc.setFont("helvetica", "bold");
doc.text("Invoice Date:", rightX, yRight);
doc.setFont("helvetica", "normal");
doc.text(`${inv.date}`, rightX + 30, yRight); // same offset


    let y = Math.max(yLeft, yRight) + 10;

    const rows = inv.items.map((it, i) => [
        i + 1,
        it.description,
        it.qty,
        formatCurrency(it.price),
        formatCurrency(it.lineTotal)
    ]);

    doc.autoTable({
        startY: y,
        head: [["#", "Description", "QTY", "Unit Price (LKR)", "Total"]],
        body: rows,
        theme: "grid",
        headStyles: { fillColor: [46, 125, 96], textColor: 255, fontStyle: "bold" },
        styles: { fontSize: 10, cellPadding: 3 },
        columnStyles: { 0:{cellWidth:10},1:{cellWidth:80},2:{cellWidth:20, halign:"center"},3:{cellWidth:35, halign:"right"},4:{cellWidth:35, halign:"right"} }
    });

    let finalY = doc.lastAutoTable.finalY + 10;

    // Bottom Section
    doc.setFont("helvetica", "bold"); doc.setFontSize(14);
    doc.text("Thank You for your Business", 15, finalY);
    finalY += 7; doc.setFontSize(12); doc.text("Payment Instructions", 15, finalY);
    doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    finalY += 6;
    doc.text("Please make the payment to the bank details provided below.\nIf you have any questions, please contact us at 0777178196.", 15, finalY);
    finalY += 15;
    doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.text("Bank Details", 15, finalY);
    doc.setFont("helvetica", "normal"); doc.setFontSize(10); finalY += 6;
    doc.text("Bank Name: Commercial Bank\nAccount Name: Neranjala Sekar\nAccount Number: 8240009545\nBank Branch: Pettah Branch", 15, finalY);

    // Totals with discount
    const subtotal = inv.items.reduce((s,it)=>s+it.lineTotal,0);
    const discount = inv.discount || 0;
    const discountAmount = subtotal*(discount/100);
    const finalAmount = subtotal - discountAmount;

   const totalsX = pageWidth - 90;
let totalsY = doc.lastAutoTable.finalY + 10;

doc.text("Subtotal:", totalsX, totalsY);
doc.text(`LKR ${formatCurrency(subtotal)}`, totalsX + 72, totalsY, { align: "right" }); // moved left
totalsY += 7;

doc.text(`Discount (${discount}%):`, totalsX, totalsY);
doc.text(`LKR ${formatCurrency(discountAmount)}`, totalsX + 72, totalsY, { align: "right" }); // moved left
totalsY += 7;

doc.setFont("helvetica", "bold"); 
doc.setFontSize(12); 
doc.setFillColor(97,99,99); 
doc.setTextColor(255,255,255);
doc.rect(totalsX, totalsY - 5, 74, 10, "F"); 

doc.text("Total:", totalsX + 2, totalsY);
doc.text(`LKR ${formatCurrency(finalAmount)}`, totalsX + 72, totalsY, { align: "right" }); // moved left

doc.setTextColor(0,0,0);


    // Cheque Payment
    let chequeY = Math.max(finalY + 25, totalsY + 10);
    doc.setFont("helvetica", "bold"); doc.setFontSize(12); doc.text("Cheque Payment", 15, chequeY);
    chequeY += 6; doc.setFont("helvetica", "normal"); doc.setFontSize(10);
    doc.text("Please make the cheque payable to: NMD Accountancy", 15, chequeY);

    // Footer
    let footerY = pageHeight - 20; doc.setFontSize(9); doc.setTextColor(85,85,85);
    doc.text("If you have any questions about this invoice, please contact nmdacc2018@gmail.com or 0777178196", pageWidth/2, footerY, { align: "center" });

    doc.save(`${inv.number}.pdf`);
}

    // convenience wrapper
    function updatePreview(){ showPreview(buildCurrentInvoice()); }

    // ===== Save Invoice =====
// ===== Save Invoice + Generate PDF + Print Preview =====
function saveInvoiceAndPDF() {
    const invObj = buildCurrentInvoice();

    // Basic validation
    if (!invObj.client || !invObj.date) {
        alert("Please fill client name and date before saving.");
        return;
    }

    // Save new client if not exist
    let clients = JSON.parse(localStorage.getItem('clients') || '[]');
    if (!clients.some(c => c.name.toLowerCase() === invObj.client.toLowerCase())) {
        clients.push({ name: invObj.client, contact: invObj.contact, location: invObj.location });
        localStorage.setItem('clients', JSON.stringify(clients));
        populateClientsDropdown();
    }

    // Compute totals
    const subtotal = invObj.items.reduce((s, it) => s + (parseFloat(it.lineTotal) || 0), 0);
    const discount = parseFloat(invObj.discount) || 0;
    invObj.totalAfterDiscount = subtotal - subtotal * (discount / 100);

    // Save invoice in localStorage
    let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    invoices.push(invObj);
    localStorage.setItem('invoices', JSON.stringify(invoices));

    // Show preview
    showPreview(invObj);

    // Generate PDF using jsPDF + autoTable
    generatePDF(invObj);

    // Optional: open print preview
    printInvoice(invObj);

    alert("Invoice saved, PDF generated, and print preview opened!");

    // Clear table rows but keep client info
    invoiceTableBody.innerHTML = '';
    invoiceCount = 0;
    addLineRow();
    updateInvoiceNumberField();
    updatePreview();
}

// Attach to button
document.getElementById("generateInvoice").addEventListener("click", saveInvoiceAndPDF);


    // ===== Init =====
    document.addEventListener("DOMContentLoaded", ()=> {
        // default date to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("invoiceDate").value = today;

        // Populate clients list
        populateClientsDropdown();

        // initial invoice number
        updateInvoiceNumberField();

        // attach listeners
        document.getElementById("invoiceDate").addEventListener("change", ()=>{ updateInvoiceNumberField(); updatePreview(); });
        document.getElementById("invoiceType").addEventListener("change", ()=>{ updateInvoiceNumberField(); updatePreview(); });
        document.getElementById("clientName").addEventListener("change", handleClientChange);
        document.getElementById("contactNumber").addEventListener("input", updatePreview);
        document.getElementById("clientLocation").addEventListener("input", updatePreview);
        document.getElementById("discountPercent").addEventListener("input", updatePreview);

        document.getElementById("addLine").addEventListener("click", ()=> addLineRow());
        document.getElementById("generateInvoice").addEventListener("click", saveInvoice);

        // sidebar toggle (existing)
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.getElementById('sidebarToggle');
        toggleBtn.addEventListener('click', ()=>{
            sidebar.classList.toggle('collapsed');
            toggleBtn.classList.toggle('collapsed');
        });

        // start with one row
        addLineRow();
        updatePreview();

        // live date/time
        function updateDateTime(){
            const now = new Date();
            const options={ weekday:'short', year:'numeric', month:'short', day:'numeric',
                hour:'2-digit', minute:'2-digit', second:'2-digit'};
            document.getElementById('systemDateTime').textContent = now.toLocaleDateString('en-US', options);
        }
        setInterval(updateDateTime,1000);
        updateDateTime();
    });

        // ------------------------------
// COLLAPSIBLE SIDEBAR
// ------------------------------
const sidebar = document.querySelector('.sidebar');
const toggleBtn = document.getElementById('sidebarToggle');
toggleBtn.addEventListener('click', ()=>{
    sidebar.classList.toggle('collapsed');
    toggleBtn.classList.toggle('collapsed');
});

    // ------------------------------
    // LOGOUT & INACTIVITY (existing)
    // ------------------------------
    document.getElementById('navLogout').addEventListener('click', ()=>{
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('userEmail');
        window.location.href = 'home.html';
    });

    const AUTO_LOGOUT_TIME = 15*60*1000;
    let logoutTimer;
    function startLogoutTimer(){
        logoutTimer = setTimeout(()=>{
            alert("You have been logged out due to inactivity.");
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userEmail');
            window.location.href = 'home.html';
        }, AUTO_LOGOUT_TIME);
    }
    function resetLogoutTimer(){
        clearTimeout(logoutTimer);
        startLogoutTimer();
    }
    document.addEventListener('mousemove', resetLogoutTimer);
    document.addEventListener('keydown', resetLogoutTimer);
    document.addEventListener('click', resetLogoutTimer);
    startLogoutTimer();

    //currancy
    function formatCurrency(num) {
    return Number(num).toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}
</script>

</body>
</html>
